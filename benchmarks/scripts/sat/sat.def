BootStrap: docker
From: rust:1.84
Stage: build

%files
    ../../../compiler/* /opt/compiler/
    mltlsat.py /opt/

%post
    apt-get -y update
    apt-get -y install python3 python3-pip ninja-build

    mkdir /opt/compiler/deps

    git clone https://github.com/egraphs-good/egglog.git /opt/compiler/deps/egglog
    cd /opt/compiler/deps/egglog
    git checkout v0.4.0
    cargo build --bin egglog --release

    cd /opt/compiler/deps

    wget https://github.com/Z3Prover/z3/releases/download/z3-4.14.0/z3-4.14.0-x64-glibc-2.35.zip
    unzip z3-4.14.0-x64-glibc-2.35.zip
    mv z3-4.14.0-x64-glibc-2.35 z3
    rm z3-4.14.0-x64-glibc-2.35.zip

    wget https://yices.csl.sri.com/releases/2.6.5/yices-2.6.5-x86_64-pc-linux-gnu-static-gmp.tar.gz
    tar -xvf yices-2.6.5-x86_64-pc-linux-gnu-static-gmp.tar.gz
    mv yices-2.6.5 yices2
    rm yices-2.6.5-x86_64-pc-linux-gnu-static-gmp.tar.gz

    wget https://github.com/cvc5/cvc5/releases/download/cvc5-1.2.1/cvc5-Linux-x86_64-static.zip
    unzip cvc5-Linux-x86_64-static.zip
    mv cvc5-Linux-x86_64-static cvc5
    rm cvc5-Linux-x86_64-static.zip

    wget https://mathsat.fbk.eu/download.php?file=mathsat-5.6.11-linux-x86_64.tar.gz
    tar -xvf "download.php?file=mathsat-5.6.11-linux-x86_64.tar.gz"
    mv mathsat-5.6.11-linux-x86_64 mathsat5
    rm "download.php?file=mathsat-5.6.11-linux-x86_64.tar.gz"

    git clone https://github.com/bitwuzla/bitwuzla
    cd bitwuzla
    git checkout 0.7.0
    pip3 install --break-system-packages meson
    ./configure.py release
    cd build && ninja


BootStrap: docker
From: python:3.11

%files from build
    /opt/* /opt/

%environment
    export PATH=$PATH:/opt/compiler/deps/egglog/target/release
    export PATH=$PATH:/opt/compiler/deps/z3/bin
    export PATH=$PATH:/opt/compiler/deps/yices2/bin
    export PATH=$PATH:/opt/compiler/deps/cvc5/bin
    export PATH=$PATH:/opt/compiler/deps/mathsat5/bin
    export PATH=$PATH:/opt/compiler/deps/bitwuzla/build/src/main

%test
    egglog --version
    z3 --version
    cvc5 --version
    mathsat -version
    bitwuzla --version
    python3 /opt/compiler/c2po.py -bz -c --sat --eqsat --extops /opt/compiler/test/sat/sat_1.mltl --debug

%runscript
    python3 /opt/mltlsat.py $*

%labels
    Author chris
